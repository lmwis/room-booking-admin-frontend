<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>编辑页面-Fehead Admin 后台管理系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../static/css/font.css">
    <link rel="stylesheet" href="../../static/css/weadmin.css">
    <script src="../../static/js/global.js" charset="utf-8"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="weadmin-body">
    <form class="layui-form">
        <div class="layui-form-item">
            <label for="id" class="layui-form-label">
                <span class="we-red">*</span>id
            </label>
            <div class="layui-input-inline">
                <input type="text" id="id" name="id" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input" disabled>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="applicant" class="layui-form-label">
                <span class="we-red">*</span>申请人
            </label>
            <div class="layui-input-inline">
                <input type="text" id="applicant" name="applicant" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="college" class="layui-form-label">
                <span class="we-red">*</span>学院
            </label>
            <div class="layui-input-inline">
                <input type="text" id="college" name="college" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="classes" class="layui-form-label">
                <span class="we-red">*</span>班级
            </label>
            <div class="layui-input-inline">
                <input type="text" id="classes" name="classes" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="identity" class="layui-form-label">
                <span class="we-red">*</span>岗位
            </label>
            <div class="layui-input-inline">
                <input type="text" id="identity" name="identity" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="email" class="layui-form-label">
                <span class="we-red">*</span>邮箱
            </label>
            <div class="layui-input-inline">
                <input type="text" id="email" name="email" required="" lay-verify="required"
                       autocomplete="off" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="jobNumber" class="layui-form-label">
                <span class="we-red">*</span>工号/学号
            </label>
            <div class="layui-input-inline">
                <input type="text" id="jobNumber" name="jobNumber" required="" lay-verify="required"
                       autocomplete="off" value=" " class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="phoneNumber" class="layui-form-label">
                <span class="we-red">*</span>电话
            </label>
            <div class="layui-input-inline">
                <input type="text" value="" id="phoneNumber" name="phoneNumber" required="" lay-verify="phone"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="roomId" class="layui-form-label">
                <span class="we-red">*</span>申请会议室
            </label>
            <div class="layui-input-inline">
                <select id="roomId" name="roomId">
                    <option name="roomId" value="1">403网络直播间</option>
                    <option name="roomId" value="2">404共享会议室</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label for="reasonsForApplication" class="layui-form-label">
                <span class="we-red">*</span>申请用途
            </label>
            <div class="layui-input-inline">
                <input type="text" value="" id="reasonsForApplication" name="reasonsForApplication" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="apply-day" class="layui-form-label">
                <span class="we-red">*</span>预约日期
            </label>
            <div class="layui-input-inline">
                <input type="text" value="" id="apply-day" name="apply-day" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="start-time" class="layui-form-label">
                <span class="we-red">*</span>预约时间
            </label>
            <div class="layui-input-inline">
                <input type="text" value="" id="start-time" name="start-time" required="" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
            <div class="layui-input-inline">
                <input type="text" value="" id="end-time" name="end-time" required="" lay-verify="required"
                       autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label for="remarks" class="layui-form-label">
                <span class="we-red">*</span>备注
            </label>
            <div class="layui-input-inline">
                <textarea type="text" id="remarks" name="remarks" required=""
                          autocomplete="off" class="layui-textarea"></textarea>
            </div>
        </div>
        <!--<div class="layui-form-item">-->
        <div>
            <label class="layui-form-label"><span class="we-red">*</span>状态</label>
            <div  class="layui-input-inline">
                <select id="status" name="status">
                    <option value="0">未处理</option>
                    <option value="1">已通过</option>
                    <option value="2">已拒绝</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <button class="layui-btn" lay-filter="add" lay-submit="">
                保存
            </button>
        </div>
        <!-- 隐藏表单来装别的数据 -->
        <input id="applicationStamp" name="applicationStamp" type="hidden">
        <input id="endStamp" name="endStamp" type="hidden">
        <input id="startStamp" name="startStamp" type="hidden">
        <input id="roomStatusId" name="roomStatusId" type="hidden">
    </form>
</div>
<script src="../../lib/layui/layui.js" charset="utf-8"></script>
<script type="text/javascript">
    layui.extend({
        admin: '{/}../../static/js/admin'
    });
    layui.use(['form', 'layer', 'admin','laydate','jquery'], function () {
        var form = layui.form,
            laydate = layui.laydate,
            layer = layui.layer,
            $ = layui.$;

        let id = getUrlParam("id");
        $.ajax({
            url: hostPre + "api/v1/applications/"+id+"?role=admin",
            // url: "http://localhost:9200/application/_doc/"+id,
            type: "get",
            headers: {
                "Authorization": "Bearer "+localStorage.getItem("token")
            },
            success: function (res) {
                // res = res._source;
                $("#id").val(id);
                $("#applicant").val(res.data.applicant);
                $("#college").val(res.data.college);
                $("#classes").val(res.data.classes);
                $("#identity").val(res.data.identity);
                $("#email").val(res.data.email);
                $("#jobNumber").val(res.data.jobNumber);
                $("#phoneNumber").val(res.data.phoneNumber);
                $("#reasonsForApplication").val(res.data.reasonsForApplication);
                // console.log(timestampToString(res.data.startStamp));
                $("#apply-day").val(new Date(res.data.startStamp).format("yyyy-MM-dd"));
                $("#start-time").val(new Date(res.data.startStamp).format("hh:mm:ss"));
                $("#end-time").val(new Date(res.data.endStamp).format("hh:mm:ss"));
                $("#remarks").val(res.data.remarks);
                $("#status").val(res.data.status);
                $("#roomId").val(res.data.roomId);

                // 隐藏属性设置
                $("#applicationStamp").val(res.data.applicationStamp);
                $("#endStamp").val(res.data.endStamp);
                $("#startStamp").val(res.data.startStamp);
                $("#roomStatusId").val(res.data.roomStatusId);

                form.render('select');
            },
            error: function (res) {
                if (res.status === 401) {
                    console.log("未授权");
                    parent.window.location.href = '../../login.html';
                    localStorage.removeItem("token");
                } else {

                }
            }
        });
        //执行一个laydate实例l
        laydate.render({
            elem: '#apply-day' //指定元素
        });
        laydate.render({
            elem: '#start-time', //指定元素
            type: 'time'
        });
        laydate.render({
            elem: '#end-time', //指定元素
            type: 'time'
        });
        //监听提交
        form.on('submit(add)', function (data) {
            console.log(data);
            let jsonData={
                "remarks":data.field.remarks,
                "email":data.field.email
            };
            data.field.startStamp = new Date($("#apply-day").val()+" "+$("#start-time").val()).getTime();
            data.field.endStamp = new Date($("#apply-day").val()+" "+$("#end-time").val()).getTime();
            $.ajax({
                url: hostPre + "api/v1/applications/" + id + "?role=admin",
                type: "put",
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("token"),
                    "content-type":"application/json"
                },
                data:JSON.stringify (data.field),
                success:function (res) {
                    console.log(res);
                    if(res.status=="success"){
                        layer.alert("修改成功", {icon: 1}, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            parent.layer.close(index);
                            parent.initData();
                        });
                    }else{
                        layer.alert("修改失败", {icon: 2}, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            // parent.layer.close(index);
                            // parent.
                        });
                    }

                },
                error: function (res) {
                    console.log(res);
                    if (res.status === 401) {
                        console.log("未授权");
                        parent.window.location.href = '../../login.html';
                        localStorage.removeItem("token");
                    } else {
                        console.log(res);
                    }
                }
            });
            return false;
        });

    });
</script>
</body>

</html>